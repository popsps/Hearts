FROM maven:3-amazoncorretto-17 AS builder
WORKDIR /workspace
COPY . .
ENV DB_HOST=${DB_HOST}
ENV DB_PORT=${DB_PORT}
ENV DB_NAME=${DB_NAME}
ENV DB_USER=${DB_USER}
ENV DB_PASSWORD=${DB_PASSWORD}
ENV SSL_PATH=${SSL_PATH}
ENV SSL_PASSWORD=${SSL_PASSWORD}
ENV SSL_ALIAS=${SSL_ALIAS}
ENV AUTH_JWT_PRIVATE_KEY=${AUTH_JWT_PRIVATE_KEY}
ENV AUTH_JWT_PUBLIC_KEY=${AUTH_JWT_PUBLIC_KEY}
RUN mvn clean package -DskpTests

FROM amazoncorretto:17-alpine
WORKDIR /workspace
ENV DB_HOST=${DB_HOST}
ENV DB_PORT=${DB_PORT}
ENV DB_NAME=${DB_NAME}
ENV DB_USER=${DB_USER}
ENV DB_PASSWORD=${DB_PASSWORD}
ENV SSL_PATH=${SSL_PATH}
ENV SSL_PASSWORD=${SSL_PASSWORD}
ENV SSL_ALIAS=${SSL_ALIAS}
ENV AUTH_JWT_PRIVATE_KEY=${AUTH_JWT_PRIVATE_KEY}
ENV AUTH_JWT_PUBLIC_KEY=${AUTH_JWT_PUBLIC_KEY}
COPY src/main/resources/keystore ./keystore
COPY --from=builder /workspace/target/*jar ./server.jar
ENTRYPOINT ["java", "-jar", "server.jar"]